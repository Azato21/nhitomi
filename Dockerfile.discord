FROM node:lts-alpine as discord
WORKDIR /app

COPY nhitomi-discord/package*.json ./
COPY scripts ../scripts/
RUN npm install

# java 8 required by openapi-generator
RUN apk add --no-cache openjdk8-jre
RUN npm run genclient

COPY nhitomi-discord ./
RUN npm run build
RUN npm run prestart

FROM node:lts-alpine as app
WORKDIR /app

COPY --from=discord /app/build ./
COPY --from=discord /app/node_modules ./node_modules/

ENV NODE_ENV production
ENTRYPOINT ["node", "index.js"]
